version: '3.8'

services:
  hesk-api:
    build: .
    container_name: hesk-api
    env_file:
      - .env.docker
    ports:
      # Le port est configuré dans .env.docker (HOST_PORT)
      - "${HOST_PORT:-3000}:${CONTAINER_PORT:-3000}"
    environment:
      # Configuration du serveur
      - PORT=${CONTAINER_PORT:-3000}
      - NODE_ENV=${NODE_ENV:-production}

      # JWT Secret (configuré dans .env.docker)
      - JWT_SECRET=${JWT_SECRET}

      # Identifiants admin (configurés dans .env.docker)
      - ADMIN_USERNAME=${ADMIN_USERNAME}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}

      # Clé de chiffrement (configurée dans .env.docker)
      - ENCRYPTION_KEY=${ENCRYPTION_KEY}

      # Base de données
      - DB_PATH=${DB_PATH:-/app/data/database.sqlite}

      # Rate Limiting
      - RATE_LIMIT_WINDOW_MS=${RATE_LIMIT_WINDOW_MS:-900000}
      - RATE_LIMIT_MAX_REQUESTS=${RATE_LIMIT_MAX_REQUESTS:-100}

    volumes:
      # Persister la base de données
      - hesk-data:/app/data

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  hesk-data:
    driver: local
